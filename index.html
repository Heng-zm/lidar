<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrix Cam (AI LiDAR Depth)</title>
    <!-- Import Google MediaPipe AI -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            touch-action: none;
            user-select: none;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Loading Spinner */
        #loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #0f0;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            z-index: 200;
            text-shadow: 0 0 10px #0f0;
        }

        /* UI Panel */
        .ui-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(0, 20, 0, 0.9);
            border: 1px solid #0f0;
            padding: 15px;
            border-radius: 12px;
            z-index: 100;
            display: flex;
            gap: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            transition: opacity 0.5s;
        }
        
        .ui-hidden { opacity: 0; pointer-events: none; }

        button {
            flex: 1;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
        }
        button:active { background: #0f0; color: black; }

        .slider-group {
            flex: 2;
            display: flex;
            flex-direction: column;
            color: #0f0;
        }
        
        label { font-size: 10px; margin-bottom: 5px; }
        input[type=range] { accent-color: #0f0; }

        video { display: none; }
    </style>
</head>
<body>

    <div id="loader">INITIALIZING AI DEPTH SCANNER...<br><span style="font-size:12px">Please Wait</span></div>

    <div class="ui-container" id="ui">
        <button id="btnSwitch">SWITCH CAM</button>
        <div class="slider-group">
            <label>DEPTH THRESHOLD</label>
            <input type="range" id="threshold" min="0" max="100" value="50">
        </div>
        <button id="btnSnap">SAVE</button>
    </div>

    <!-- Hidden Video Element for MediaPipe -->
    <video id="input_video" playsinline></video>
    <canvas id="output_canvas"></canvas>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const ctx = canvasElement.getContext('2d', { alpha: false });
        const loader = document.getElementById('loader');
        const sliderThreshold = document.getElementById('threshold');
        
        // Glyphs
        const CHARS_FOREGROUND = " ﾊﾐﾋｰｳｼﾅﾓﾆｻﾜﾂｵﾘｱﾎﾃﾏｹﾒｴｶｷﾑﾕﾗｾﾈｽﾀﾇﾍ"; // Matrix
        const CHARS_BACKGROUND = " 01"; // Binary
        
        let width, height;
        let activeEffect = true;
        
        // --- 1. SETUP AI (MediaPipe) ---
        const selfieSegmentation = new SelfieSegmentation({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
        }});

        selfieSegmentation.setOptions({
            modelSelection: 1, // 0 = Fast, 1 = High Accuracy
        });

        selfieSegmentation.onResults(onResults);

        // --- 2. CAMERA SETUP ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await selfieSegmentation.send({image: videoElement});
            },
            width: 640,
            height: 480,
            facingMode: 'user' // Default to front
        });

        // Start Camera
        camera.start().then(() => {
            loader.style.display = 'none';
        });

        // --- 3. THE RENDER LOOP (Called by AI) ---
        function onResults(results) {
            // Resize Canvas if needed
            if (canvasElement.width !== window.innerWidth || canvasElement.height !== window.innerHeight) {
                canvasElement.width = window.innerWidth;
                canvasElement.height = window.innerHeight;
            }
            width = canvasElement.width;
            height = canvasElement.height;

            // Prepare Background Canvas (To read pixels)
            // We draw the raw video image to an invisible canvas to get RGB data
            const tmpCanvas = document.createElement('canvas');
            const tmpCtx = tmpCanvas.getContext('2d');
            const cols = 80; // Fixed resolution for performance
            const rows = Math.ceil(cols * (height/width));
            
            tmpCanvas.width = cols;
            tmpCanvas.height = rows;
            
            // Draw Video (Mirrored)
            tmpCtx.translate(cols, 0);
            tmpCtx.scale(-1, 1);
            tmpCtx.drawImage(results.image, 0, 0, cols, rows);
            
            // Draw Mask (The AI Depth Map)
            // MediaPipe gives us a mask where the human is white and background is black
            const maskCanvas = document.createElement('canvas');
            const maskCtx = maskCanvas.getContext('2d');
            maskCanvas.width = cols;
            maskCanvas.height = rows;
            
            maskCtx.translate(cols, 0);
            maskCtx.scale(-1, 1);
            maskCtx.drawImage(results.segmentationMask, 0, 0, cols, rows);

            // Get Data Arrays
            const imgData = tmpCtx.getImageData(0, 0, cols, rows).data;
            const maskData = maskCtx.getImageData(0, 0, cols, rows).data;

            // --- DRAW MATRIX ---
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, width, height);

            const fontSize = width / cols;
            ctx.font = `bold ${fontSize}px monospace`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            const cutoff = sliderThreshold.value * 2.55; // 0-255

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const i = (y * cols + x) * 4;
                    
                    // 1. Check AI Mask (Alpha channel)
                    // maskData[i] is R, [i+3] is Alpha. MediaPipe usually puts confidence in R.
                    const confidence = maskData[i]; 

                    // 2. Get Brightness
                    const r = imgData[i];
                    const g = imgData[i+1];
                    const b = imgData[i+2];
                    let brightness = (r+g+b)/3;

                    // 3. LOGIC: Is it Human or Background?
                    let isHuman = confidence > 100; // If confidence > 100, it's the person

                    // Determine Style based on Depth
                    let charSet, color;
                    
                    if (isHuman) {
                        // FOREGROUND (You)
                        charSet = CHARS_FOREGROUND;
                        // Bright Green
                        color = `rgb(50, 255, 50)`; 
                        // Boost brightness for foreground
                        brightness = brightness * 1.5;
                    } else {
                        // BACKGROUND (Room)
                        charSet = CHARS_BACKGROUND;
                        // Dark Green / Dim
                        color = `rgba(0, 100, 0, 0.5)`; 
                        brightness = brightness * 0.5;
                    }

                    if (brightness < 20) continue;

                    // Map Character
                    const charIdx = Math.floor((brightness / 255) * (charSet.length - 1));
                    const safeIdx = Math.max(0, Math.min(charSet.length-1, charIdx));
                    const char = charSet[safeIdx];

                    // Draw
                    ctx.fillStyle = color;
                    ctx.fillText(char, x * fontSize + fontSize/2, y * fontSize + fontSize/2);
                }
            }
        }

        // --- BUTTONS ---
        document.getElementById('btnSnap').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'lidar_matrix.png';
            link.href = canvasElement.toDataURL();
            link.click();
        });

        document.body.addEventListener('click', (e) => {
             if (!e.target.closest('.ui-container')) {
                document.getElementById('ui').classList.toggle('ui-hidden');
            }
        });

    </script>
</body>
</html>
